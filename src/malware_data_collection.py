from ast import keyword
import os
import json
from collections import defaultdict # generates default key if missing 

dataset = defaultdict(list)

# loop through enterprise attack-pattern:
root_folder = '../data/'
folder_names = ['malware', 'ics-malware']

for folder_name in folder_names: 
    
    folder = os.path.join(root_folder, folder_name)
    
    for filename in os.listdir(folder): 
        if filename.endswith('.json'):
            with open(os.path.join(folder, filename)) as file:
                
                file_json = json.load(file)["objects"][0] 

                # retrieve information:
                if 'x_mitre_aliases' in file_json:
                    attack_names = file_json['x_mitre_aliases']
                else:
                    attack_names = [file_json['name']]
                
                urls = []
                 
                mitre_domain = file_json['x_mitre_domains']
                
                for ref in file_json['external_references'][1:]:
                    if 'url' in ref: # check if source has url 
                        url = ref['url'] # retrieve url 

                        # filtering out unecessary reports:
                        filtering = ['mitre', 'youtube', 'wikipedia', 'git', \
                            'amazon', 'gitlab', 'capec', 'zip']
                        
                        urls.append(url)

                        if all(keyword not in url.lower() for keyword in filtering):
                            dataset[url].append((mitre_domain))
    

for name, dataset in [('malware_information.json', dataset)]:
    print(name, len(dataset))
    with open(name, 'w') as file:
        json.dump(dataset, file)
